/**
 * @fileoverview Firestore Security Rules for RunAndDeploy application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Users can only read and write their own profile data and deployed sites.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information.
 * - /users/{userId}/deployedSites/{siteId}: Stores deployed sites associated with a specific user.
 *
 * Key Security Decisions:
 * - Users can only create their own user document (self-registration).
 * - Users can only manage their own deployed sites.
 * - Listing all users is disallowed for privacy.
 * - Data validation ensures that the `userId` in a document matches the owner's UID.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description: Controls access to user profile information.
     * @path: /users/{userId}
     */
    match /users/{userId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner();
      allow list: if false; // Prevent listing all users

      allow create: if isOwner() && request.resource.data.id == userId;
      allow update: if isOwner() && request.resource.data.id == userId;
      allow delete: if false; // Users should not be able to delete their own profiles easily
      
      /**
       * @description: Controls access to deployed sites for a specific user.
       * @path: /users/{userId}/deployedSites/{siteId}
       */
      match /deployedSites/{siteId} {
        allow get, list: if isOwner();
        allow create: if isOwner() && request.resource.data.userId == userId;
        allow delete: if isOwner();
        allow update: if false; // Deployed links are immutable
      }
    }
  }
}
